!function(e,t){"use strict";t.Modal={},t.Clipboard={};const i="geodir-events-modal",s="medium",n={selector:".clipboard-init",activeClass:"active",successDuration:2e3};t.Modal.init=function(){if(!e(`#${i}`).length){const t=`\n                <div id="${i}" class="modal fade" tabindex="-1">\n                    <div class="modal-dialog">\n                        <div class="modal-content">\n                        </div>\n                    </div>\n                </div>\n            `;e("body").append(t)}this.$modal=e(`#${i}`),this.$modalContent=this.$modal.find(".modal-content"),this.bindEvents()},t.Modal.bindEvents=function(){e(document).on("click",'[data-bs-toggle="geodir-modal"]',this.handleTriggerClick.bind(this)),this.$modal.on("show.bs.modal",(()=>e(document).trigger("geodirModalBeforeShow"))),this.$modal.on("shown.bs.modal",(()=>e(document).trigger("geodirModalAfterShow"))),this.$modal.on("hide.bs.modal",(()=>e(document).trigger("geodirModalBeforeHide"))),this.$modal.on("hidden.bs.modal",(()=>e(document).trigger("geodirModalAfterHide")))},t.Modal.handleTriggerClick=function(t){t.preventDefault();const i=e(t.currentTarget);if(i.hasClass("disabled"))return;const n={action:i.data("action"),size:i.data("size")||s,static:i.data("static")||!1};this.show(n)},t.Modal.show=function(t){e(document).trigger("geodirModalBeforeLoad",[t]),"#"===t.action.charAt(0)&&this.showTemplateModal(t),e(document).trigger("geodirModalAfterLoad",[t])},t.Modal.showTemplateModal=function(t){const i=e(t.action);i.length&&(this.setSize(t.size),this.setOptions(t),this.$modalContent.html(i.html()),this.$modal.modal("show"),this.initializeModalContent())},t.Modal.setSize=function(e){this.$modal.find(".modal-dialog").removeClass("modal-sm modal-md modal-lg modal-xl").addClass({small:"modal-sm",medium:"modal-md",large:"modal-lg","extra-large":"modal-xl"}[e]||"")},t.Modal.setOptions=function(e){e.static&&(this.$modal.data("bs.modal")._config.backdrop="static",this.$modal.data("bs.modal")._config.keyboard=!1)},t.Modal.initializeModalContent=function(){e(document).trigger("geodirModalContentInitialized",[this.$modalContent]),t.Clipboard.init()},t.Clipboard={init:function(){e(document).on("click",n.selector,this.handleClick.bind(this))},handleClick:function(t){t.preventDefault();const i=e(t.currentTarget),s=i.data("clipboard-target"),o=i.data("clip-success"),a=i.data("clip-text"),l=i.find(".clipboard-text"),r=document.createRange();r.selectNode(document.querySelector(s)),window.getSelection().removeAllRanges(),window.getSelection().addRange(r);try{document.execCommand("copy"),i.addClass(n.activeClass),l.text(o),setTimeout((()=>{i.removeClass(n.activeClass),l.text(a)}),n.successDuration)}catch(e){console.error("Unable to copy text:",e)}window.getSelection().removeAllRanges()}},t.ImportStats=e.extend({},{totalEl:null,succeedEl:null,skippedEl:null,failedEl:null,init:function(e,t){return this.element=e,this.totalEl=this.element.find(".geodir-events-total"),this.succeedEl=this.element.find(".geodir-events-succeed"),this.skippedEl=this.element.find(".geodir-events-skipped"),this.failedEl=this.element.find(".geodir-events-failed"),this},updateStats:function(e){this.totalEl.text(e.total),this.succeedEl.text(e.succeed),this.skippedEl.text(e.skipped),this.failedEl.text(e.failed)}}),t.LogsHandler=e.extend({},{shown:0,init:function(e,t){return this.element=e,this},insertLogs:function(e){this.element.append(e)},setShown:function(e){this.shown=e}}),t.ProgressBar=e.extend({},{barEl:null,textEl:null,init:function(e,t){return this.element=e,this.barEl=this.element.find(".geodir-events-progress__bar"),this.textEl=this.element.find(".geodir-events-progress__text"),this},updateProgress:function(e){this.barEl.css("width",e+"%"),this.textEl.text(e+"%")}}),t.Importer={tickInterval:2e3,shortTickInterval:500,retriesCount:1,retriesLeft:0,inProgress:!1,updateTimeout:null,preventUpdates:!1,init:function(e,t){return this.element=e,this.inProgress=t.inProgress,this.resetRetries(),this.inProgress&&this.start(),this},start:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.shortTickInterval)},requestUpdate:function(){this.preventUpdates=!1,this.updateTimeout=setTimeout(this.tick.bind(this),this.tickInterval)},stop:function(){clearTimeout(this.updateTimeout),this.preventUpdates=!0},resetRetries:function(){this.retriesLeft=this.retriesCount},markInProgress:function(){this.inProgress=!0},markStopped:function(){this.inProgress=!1},trigger:function(e){this.hasOwnProperty(e)&&this[e](),this.element.trigger(e)}},t.UploadImporter=e.extend({},t.Importer,{ALLOWED_TYPES:[".ics",".ical",".icalendar"],MAX_FILE_SIZE:null,queue_id:null,importer:null,uploadArea:null,uploadAreaImport:null,uploadAreaUrl:null,uploadProcess:null,fileContent:null,filePreview:null,fileInput:null,browseButton:null,submitButton:null,success:null,error:null,progressBar:null,logsHandler:null,importStats:null,init:function(e,i){this._super=t.Importer.init,this._super(e,i),this.importer=this,this.MAX_FILE_SIZE=t.maxFileSize,this.progressBar=t.ProgressBar.init(this.element.find(".geodir-events-progress")),this.logsHandler=t.LogsHandler.init(this.element.find(".geodir-events-logs")),this.importStats=t.ImportStats.init(this.element.find(".geodir-events-import-stats")),this.uploadArea=this.element.find(".gdevents-upload-area"),this.uploadAreaImport=this.element.find(".upload-area__import"),this.uploadAreaUrl=this.element.find(".upload-area__url"),this.uploadProcess=this.element.find(".upload-area__process"),this.fileContent=this.element.find(".upload-area__content"),this.filePreview=this.element.find(".upload-area__file"),this.fileInput=this.element.find(".js_import-file"),this.urlInput=this.element.find('[name="ical_url"]'),this.browseButton=this.element.find(".js_browse-btn"),this.submitButton=this.element.find('button[type="submit"]'),this.success=this.element.find(".alert.alert-success"),this.error=this.element.find(".alert.alert-danger"),this.bindEvents()},ajax:function(i,s,n,o){o=void 0!==o?o:{},n=void 0!==n?n:{};const a=t.nonces.hasOwnProperty(i)?t.nonces[i]:"";return n instanceof FormData?(n.append("action",i),n.append("geodir_nonce",a),o.processData=!1,o.contentType=!1):(n.action=i,n.geodir_nonce=a),o=e.extend(o,{url:t.ajaxUrl,dataType:"json",data:n,success:function(e,t,i){var n=!0===e.success,o=e.data||{};s(n,o)}}),e.ajax(o)},tick:function(){var e=this;this.ajax(t.actions.ical.progress,(function(t,i){t?(e.resetRetries(),i.isFinished?e.markStopped():e.markInProgress(),e.importStats.updateStats(i),e.progressBar.updateProgress(i.progress),e.logsHandler.setShown(i.logsShown),e.logsHandler.insertLogs(i.logs),i.notice&&e.showSuccess(i.notice),e.inProgress?e.requestUpdate():(e.logsHandler.setShown(0),e.buttonStatus(e.submitButton,"reset"))):e.retriesLeft>0?(e.retriesLeft--,e.requestUpdate()):e.buttonStatus(e.submitButton,"reset")}),{logsShown:e.logsHandler.shown,queue_id:e.queue_id})},bindEvents:function(){const e=this;this.element.on("submit",(e=>this.handleSubmit(e))),this.uploadArea.on("click",(()=>this.handleAreaClick())),this.fileInput.on("change",(e=>this.handleFileSelect(e))),this.browseButton.on("click",(t=>{t.stopPropagation(),e.fileInput.click()})),this.element.find(".remove-file").on("click",(t=>e.removeFile(t))),this.uploadArea.on("dragover dragenter",(t=>e.handleDragOver(t))).on("dragleave dragend drop",(t=>e.handleDragLeave(t))).on("drop",(t=>e.handleDrop(t)))},handleAreaClick:function(){this.filePreview.hasClass("d-none")&&this.fileInput.click()},handleDragOver:function(e){e.preventDefault(),e.stopPropagation(),this.uploadArea.addClass("dragover")},handleDragLeave:function(e){e.preventDefault(),e.stopPropagation(),this.uploadArea.removeClass("dragover")},handleDrop:function(e){e.preventDefault(),e.stopPropagation(),this.uploadArea.removeClass("dragover");const t=e.originalEvent.dataTransfer.files;t.length&&this.handleFiles(t[0])},handleFileSelect:function(e){const t=e.target.files[0];t&&this.handleFiles(t)},handleFiles:function(e){const t="."+e.name.split(".").pop().toLowerCase();this.ALLOWED_TYPES.includes(t)?e.size>this.MAX_FILE_SIZE?this.showError(`File size exceeds the limit of ${this.formatBytes(this.MAX_FILE_SIZE)}`):(this.fileContent.addClass("d-none"),this.filePreview.removeClass("d-none"),this.filePreview.find(".file-name").text(e.name),this.submitButton.prop("disabled",!1),this.urlInput.prop("disabled",!0),this.hideAlerts()):this.showError("Please upload an iCal file (.ics, .ical, .icalendar)")},removeFile:function(e){e.stopPropagation(),this.fileInput.val(""),this.fileContent.removeClass("d-none"),this.filePreview.addClass("d-none"),this.urlInput.prop("disabled",!1)},handleSubmit:function(e){e.preventDefault(),this.hideAlerts();const{__:i}=wp.i18n,s=this,n=this.fileInput[0].files[0],o=this.urlInput.val();if(n||o)if(!o||this.isValidUrl(o)){var a=new FormData;n?a.append("import",n):a.append("url",o),this.ajax(t.actions.ical.import,(function(e,t){s.uploadAreaImport.slideUp(),s.uploadAreaUrl.slideUp(),s.queue_id=t.queue_id,s.importer.start()}),a,{method:"POST",beforeSend:function(){s.buttonStatus(s.submitButton,"importing"),s.uploadProcess.removeClass("d-none").slideDown()},error:function(e,t,n){s.buttonStatus(s.submitButton,"reset"),s.showError(i("There is something that went wrong!","uwpm"))}})}else this.showError(i("Please enter a valid iCal URL","uwpm"));else this.showError(i("Please upload a file or provide an iCal URL","uwpm"))},showError:function(e){this.success.is(":visible")&&this.success.addClass("d-none"),this.error.removeClass("d-none").html(e).slideDown()},showSuccess:function(e){this.error.is(":visible")&&this.error.addClass("d-none"),this.success.removeClass("d-none").html(e).slideDown()},hideAlerts:function(){this.success.addClass("d-none"),this.error.addClass("d-none")},formatBytes:function(e,t=2){if(0===e)return"0 Bytes";const i=t<0?0:t,s=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,s)).toFixed(i))+" "+["Bytes","KB","MB","GB"][s]},isValidUrl:function(e){try{return new URL(e),!0}catch(e){return!1}},buttonStatus:function(e,t){"loading"===t?(e.data("text",e.html()),e.prop("disabled",!0),e.html('<i class="fas fa-circle-notch fa-spin ml-2"></i> <span>Loading...</span>')):"importing"===t?(e.data("text",e.html()),e.prop("disabled",!0),e.html('<i class="fas fa-circle-notch fa-spin ml-2"></i> <span>Importing...</span>')):(e.prop("disabled",!1),e.html(e.data("text")))}}),e(document).on("geodirModalAfterLoad",(function(i,s){if("#geodir-event-import-calendar"===s.action){const i=e(".js_event-import");i.length&&t.UploadImporter.init(i,{inProgress:i.inProgress})}})),e(document).ready((function(){t.Modal.init()}))}(jQuery,Geodir_Events_iCal);